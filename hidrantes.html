<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ronda de Hidrantes - Inspeção em Tempo Real</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f9;
        }
        .hydrant-btn {
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
        }
        .not-inspected {
            background-color: #1e3a8a; /* Blue-900 */
            color: white;
        }
        .inspected {
            background-color: #10b981; /* Emerald-500 */
            color: white;
            animation: pulse-green 1s infinite;
        }
        @keyframes pulse-green {
            0%, 100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); }
            50% { box-shadow: 0 0 0 10px rgba(16, 185, 129, 0); }
        }
        .modal-overlay {
            z-index: 50;
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            justify-content: center;
            align-items: center;
            /* Garante que a overlay em si possa rolar, embora o modal fique no centro */
            overflow-y: auto; 
            padding: 20px;
        }
    </style>
</head>
<body>

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-extrabold text-gray-900 mb-2">SCI AEROPORTO DE JOINVILLE<br>Controle de Inspeção dos Hidrantes</h1>
            <div id="auth-info" class="text-xs text-gray-500 mt-2"></div>
        </header>

        <!-- Seção de Entrada e Controles -->
        <div class="bg-white p-6 rounded-xl shadow-lg mb-8 max-w-lg mx-auto">
            <label for="inspector-name" class="block text-sm font-medium text-gray-700 mb-2">Seu Nome para a Vistoria (Obrigatório)</label>
            <input type="text" id="inspector-name" placeholder="Digite seu nome de BA" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
            
            <button id="reset-status-btn" class="mt-4 w-full bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition duration-150 ease-in-out">
                Resetar Status dos Hidrantes (Nova Ronda)
            </button>
        </div>

        <!-- Lista de Hidrantes -->
        <div id="hydrants-container" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4">
            <!-- Botões dos hidrantes serão inseridos aqui -->
            <p id="loading-message" class="col-span-full text-center text-gray-500">Carregando hidrantes...</p>
        </div>
    </div>

    <!-- Modal de Inspeção -->
    <div id="inspection-modal" class="modal-overlay">
        <!-- A classe max-h-[90vh] e overflow-y-auto garantem que o modal tenha altura máxima e rolagem interna -->
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl p-6 md:p-8 transform transition-all duration-300 max-h-[90vh] overflow-y-auto">
            <h2 id="modal-title" class="text-3xl font-bold text-gray-900 mb-4 border-b pb-2">Hidrante: N/A</h2>
            <p id="modal-description" class="text-gray-600 mb-6"></p>

            <form id="inspection-form" class="space-y-6">
                
                <div id="basic-questions">
                    <!-- Q0.1 -->
                    <div class="p-4 bg-blue-50 rounded-lg">
                        <label class="block text-md font-semibold text-gray-800 mb-2">0.1 - A placa de sinalização do Hidrante está conforme?</label>
                        <p>A placa deve estar visível, acima de 1,8 metros de altura.</p>
                        <div class="flex space-x-4">
                            <label class="inline-flex items-center">
                                <input type="radio" name="q0_1_sinalizacao" value="Sim" class="form-radio text-blue-600">
                                <span class="ml-2">Sim</span>
                            </label>
                            <label class="inline-flex items-center">
                                <input type="radio" name="q0_1_sinalizacao" value="Não" class="form-radio text-blue-600">
                                <span class="ml-2">Não</span>
                            </label>
                        </div>
                    </div>
                    
                    <!-- Q0.2 -->
                    <div class="p-4 bg-blue-50 rounded-lg">
                        <label class="block text-md font-semibold text-gray-800 mb-2">0.2 - O Hidrante está lacrado?</label>
                        <div class="flex space-x-4">
                            <label class="inline-flex items-center">
                                <input type="radio" name="q0_2_lacrado" value="Sim" class="form-radio text-blue-600" onchange="toggleDetailedInspection()">
                                <span class="ml-2">Sim</span>
                            </label>
                            <label class="inline-flex items-center">
                                <input type="radio" name="q0_2_lacrado" value="Não" class="form-radio text-blue-600" onchange="toggleDetailedInspection()">
                                <span class="ml-2">Não</span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Seção de Inspeção Detalhada (Aparece se Q0.2 for 'Não') -->
                <div id="detailed-inspection-section" class="space-y-6 border-t pt-6 mt-6 hidden">
                    <h3 class="text-xl font-bold text-gray-700">Inspeção Detalhada (Itens Internos)</h3>
                    
                    <!-- Q1 - Mangueiras (Dinâmico) -->
                    <div id="mangueiras-container" class="p-4 border border-indigo-200 rounded-lg bg-indigo-50">
                        <label id="q1-title" class="block text-md font-semibold text-gray-800 mb-4">1 - Possui 2 mangueiras do tipo Sintética de 15 metros de 1 1/2"?</label>
                        <div class="flex space-x-4 mb-4">
                            <label class="inline-flex items-center">
                                <input type="radio" name="q1_mangueiras_conforme" value="Sim" class="form-radio text-green-600" onchange="toggleMangueirasConfig()">
                                <span class="ml-2">Sim</span>
                            </label>
                            <label class="inline-flex items-center">
                                <input type="radio" name="q1_mangueiras_conforme" value="Não" class="form-radio text-red-600" onchange="toggleMangueirasConfig()">
                                <span class="ml-2">Não</span>
                            </label>
                        </div>

                        <!-- Configurações Dinâmicas de Mangueiras (Somente se 'Não') -->
                        <div id="mangueiras-dynamic-config" class="space-y-4 hidden">
                            <h4 class="text-lg font-bold text-gray-700">Configurações Encontradas</h4>
                            <div id="mangueira-configs-list" class="space-y-4">
                                <!-- Configurações de mangueira serão adicionadas aqui -->
                            </div>
                            <button type="button" onclick="addMangueiraConfig()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition duration-150 ease-in-out">
                                + Adicionar Configuração de Mangueira
                            </button>
                            <p class="text-sm text-gray-500 mt-2">Máximo de 4 configurações.</p>
                        </div>
                    </div>

                    <!-- Q2 - Teste Hidrostático -->
                    <div class="p-4 bg-gray-50 rounded-lg">
                        <label class="block text-md font-semibold text-gray-800 mb-2">2 - Teste Hidrostático:</label>
                        <div class="flex space-x-4">
                            <label class="inline-flex items-center">
                                <input type="month" name="q2_teste_hidrostatico">
                            </label>
                            <!-- <label class="inline-flex items-center">
                                <input type="radio" name="q2_teste_hidrostatico" value="Não" class="form-radio text-blue-600">
                                <span class="ml-2">Não</span>
                            </label> -->
                        </div>
                    </div>

                    <!-- Q3 - Esguicho (com subpergunta) -->
                    <div class="p-4 bg-gray-50 rounded-lg">
                        <label class="block text-md font-semibold text-gray-800 mb-2">3 - Esguicho presente?</label>
                        <div class="flex space-x-4">
                            <label class="inline-flex items-center">
                                <input type="radio" name="q3_esguicho_presente" value="Sim" class="form-radio text-blue-600" onchange="toggleEsguichoType()">
                                <span class="ml-2">Sim</span>
                            </label>
                            <label class="inline-flex items-center">
                                <input type="radio" name="q3_esguicho_presente" value="Não" class="form-radio text-blue-600" onchange="toggleEsguichoType()">
                                <span class="ml-2">Não</span>
                            </label>
                        </div>
                        
                        <!-- Q3.1 -->
                        <div id="q3_1_tipo_esguicho_container" class="mt-4 pl-6 border-l border-gray-300 hidden">
                            <label class="block text-sm font-semibold text-gray-700 mb-2">3.1 - Qual o tipo?</label>
                            <select name="q3_1_tipo_esguicho" class="w-full px-3 py-1 border border-gray-300 rounded-lg">
                                <option value="-">Selecione o Tipo</option>
                                <option value="Agulheta">Agulheta</option>
                                <option value="Regulável">Regulável</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Q4 - Chave Storz (com subpergunta) -->
                    <div class="p-4 bg-gray-50 rounded-lg">
                        <label class="block text-md font-semibold text-gray-800 mb-2">4 - Chave Storz presente?</label>
                        <div class="flex space-x-4">
                            <label class="inline-flex items-center">
                                <input type="radio" name="q4_storz_presente" value="Sim" class="form-radio text-blue-600" onchange="toggleStorzQuantity()">
                                <span class="ml-2">Sim</span>
                            </label>
                            <label class="inline-flex items-center">
                                <input type="radio" name="q4_storz_presente" value="Não" class="form-radio text-blue-600" onchange="toggleStorzQuantity()">
                                <span class="ml-2">Não</span>
                            </label>
                        </div>

                        <!-- Q4.1 -->
                        <div id="q4_1_quantidade_storz_container" class="mt-4 pl-6 border-l border-gray-300 hidden">
                            <label class="block text-sm font-semibold text-gray-700 mb-2">4.1 - Quantas?</label>
                            <select name="q4_1_quantidade_storz" class="w-full px-3 py-1 border border-gray-300 rounded-lg">
                                <option value="-">Selecione a Quantidade</option>
                                <option value="1">1</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Perguntas Finais -->
                <div class="space-y-6 pt-6 border-t mt-6">
                    <!-- Q5 -->
                    <div class="p-4 bg-yellow-50 rounded-lg">
                        <label class="block text-md font-semibold text-gray-800 mb-2">5 - Integridade OK?</label>
                        <p>Verifique: Registro, porta, estrutura, se há obstáculos ou vazamentos e limpeza. </p>
                        <div class="flex space-x-4">
                            <label class="inline-flex items-center">
                                <input type="radio" name="q5_itens_conformidade" value="Sim" class="form-radio text-blue-600">
                                <span class="ml-2">Sim</span>
                            </label>
                            <label class="inline-flex items-center">
                                <input type="radio" name="q5_itens_conformidade" value="Não" class="form-radio text-blue-600">
                                <span class="ml-2">Não</span>
                            </label>
                        </div>
                    </div>

                    <!-- Q6 - Observação -->
                    <div class="p-4 bg-yellow-50 rounded-lg">
                        <label for="q6_observacao" class="block text-md font-semibold text-gray-800 mb-2">6 - Alguma observação?</label>
                        <textarea id="q6_observacao" name="q6_observacao" rows="3" placeholder="Digite suas observações aqui..." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"></textarea>
                    </div>

                    <!-- Q7 - Equipe -->
                    <div class="p-4 bg-yellow-50 rounded-lg">
                        <label for="q7_equipe" class="block text-md font-semibold text-gray-800 mb-2">7 - Equipe:</label>
                        <select id="q7_equipe" name="q7_equipe" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                            <option value="-">Selecione a Equipe</option>
                            <option value="Alfa">Alfa</option>
                            <option value="Bravo">Bravo</option>
                            <option value="Charlie">Charlie</option>
                            <option value="Delta">Delta</option>
                        </select>
                    </div>
                </div>

                <!-- Botões de Ação -->
                <div class="flex justify-end space-x-4 pt-4 border-t">
                    <button type="button" onclick="closeModal()" class="px-6 py-2 bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold rounded-lg transition duration-150 ease-in-out">
                        CANCELAR
                    </button>
                    <button type="submit" class="px-6 py-2 bg-green-600 hover:bg-green-700 text-white font-bold rounded-lg transition duration-150 ease-in-out">
                        <span id="submit-text">ENVIAR VISTORIA</span>
                        <svg id="loading-spinner" class="animate-spin h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                    </button>
                </div>
                
                <div id="modal-message" class="mt-4 text-center p-2 rounded-lg hidden"></div>
            </form>
        </div>
    </div>

    <!-- Firebase Imports and Script -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, query, writeBatch, deleteDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Ativar logs de debug para o Firestore
        setLogLevel('Debug');
        
        // Variáveis Globais do Canvas (OBRIGATÓRIO USAR)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyCInOMNcg0PEd2EJGgkGXk2QOp1HHPjMsw",
            authDomain: "ronda-hidrantes.firebaseapp.com",
            projectId: "ronda-hidrantes",
            storageBucket: "ronda-hidrantes.firebasestorage.app",
            messagingSenderId: "599277880651",
            appId: "1:599277880651:web:5a440d1a2ad1bb36ea14ce"
        };
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Configurações do App Script (APIs)
        // Você DEVE substituir este URL pelo seu App Script URL DEPLOYED
        const APP_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwsmiLlJCcQUPm3DPAKwvXpUTIVPvt0IfBMaFN1bmWdgft3DvyJMSRKfHw4yXO36Hft/exec"; // Placeholder/Example. TROQUE ESTE URL!

        // Dados estáticos dos hidrantes
        const HYDRANT_DATA = [
            { id: "H1-01",     numero: 1,     edificacao: "RÁDIO-ADM",      descricao: "Lado terra",                      qtdMangueiras: 3, tipoMangueira: "2", tamanhoMangueira: 15, polegadaMangueira: '1½"', tipoEsguicho: "Regulável", qtdEsguicho: 1, qtdStorz: 1 },
            { id: "H2-02",     numero: 2,     edificacao: "TPS TÉRREO",     descricao: "Check-in GOL",                    qtdMangueiras: 2, tipoMangueira: "2", tamanhoMangueira: 15, polegadaMangueira: '2½"', tipoEsguicho: "Agulheta",  qtdEsguicho: 1, qtdStorz: 1 },
            { id: "H3-03",     numero: 3,     edificacao: "TPS TÉRREO",     descricao: "Entrada check-in",                qtdMangueiras: 2, tipoMangueira: "2", tamanhoMangueira: 15, polegadaMangueira: '2½"', tipoEsguicho: "Agulheta",  qtdEsguicho: 1, qtdStorz: 1 },
            { id: "H4-04",     numero: 4,     edificacao: "TPS TÉRREO",     descricao: "Acesso C",                        qtdMangueiras: 2, tipoMangueira: "2", tamanhoMangueira: 15, polegadaMangueira: '2½"', tipoEsguicho: "Agulheta",  qtdEsguicho: 1, qtdStorz: 1 },
            { id: "H5-05",     numero: 5,     edificacao: "TPS TÉRREO",     descricao: "Sanitário Feminino.",             qtdMangueiras: 2, tipoMangueira: "2", tamanhoMangueira: 15, polegadaMangueira: '2½"', tipoEsguicho: "Agulheta",  qtdEsguicho: 1, qtdStorz: 1 },
            { id: "H6-06",     numero: 6,     edificacao: "TPS TÉRREO",     descricao: "Embaixo escada rolante",          qtdMangueiras: 2, tipoMangueira: "2", tamanhoMangueira: 15, polegadaMangueira: '2½"', tipoEsguicho: "Agulheta",  qtdEsguicho: 1, qtdStorz: 1 },
            { id: "H7-07",     numero: 7,     edificacao: "TPS TÉRREO",     descricao: "Desembarque",                     qtdMangueiras: 2, tipoMangueira: "2", tamanhoMangueira: 15, polegadaMangueira: '2½"', tipoEsguicho: "Agulheta",  qtdEsguicho: 1, qtdStorz: 1 },
            { id: "H8-08",     numero: 8,     edificacao: "TPS TÉRREO",     descricao: "Saída desembarque",               qtdMangueiras: 2, tipoMangueira: "2", tamanhoMangueira: 15, polegadaMangueira: '2½"', tipoEsguicho: "Agulheta",  qtdEsguicho: 1, qtdStorz: 1 },
            { id: "H9-09",     numero: 9,     edificacao: "TPS SUPERIOR",   descricao: "Elevador",                        qtdMangueiras: 2, tipoMangueira: "2", tamanhoMangueira: 15, polegadaMangueira: '2½"', tipoEsguicho: "Agulheta",  qtdEsguicho: 1, qtdStorz: 1 },
            { id: "H10-10",    numero: 10,    edificacao: "TPS SUPERIOR",   descricao: "Próximo ao COE",                  qtdMangueiras: 2, tipoMangueira: "2", tamanhoMangueira: 15, polegadaMangueira: '2½"', tipoEsguicho: "Agulheta",  qtdEsguicho: 1, qtdStorz: 1 },
            { id: "H11-11",    numero: 11,    edificacao: "TPS SUPERIOR",   descricao: "Saída de Emergência",             qtdMangueiras: 2, tipoMangueira: "2", tamanhoMangueira: 15, polegadaMangueira: '1½"', tipoEsguicho: "Agulheta",  qtdEsguicho: 1, qtdStorz: 1 },
            { id: "H12-12",    numero: 12,    edificacao: "TPS SUPERIOR",   descricao: "Entrada Raio-x",                  qtdMangueiras: 2, tipoMangueira: "2", tamanhoMangueira: 15, polegadaMangueira: '2½"', tipoEsguicho: "Agulheta",  qtdEsguicho: 1, qtdStorz: 2 },
            { id: "H13-13",    numero: 13,    edificacao: "TPS SUPERIOR",   descricao: "Escada rolante embarque",         qtdMangueiras: 2, tipoMangueira: "2", tamanhoMangueira: 15, polegadaMangueira: '2½"', tipoEsguicho: "Agulheta",  qtdEsguicho: 1, qtdStorz: 1 },
            { id: "H14-14",    numero: 14,    edificacao: "TPS TÉRREO",     descricao: "Embaixo escada rolante embarque", qtdMangueiras: 2, tipoMangueira: "2", tamanhoMangueira: 15, polegadaMangueira: '1½"', tipoEsguicho: "Agulheta",  qtdEsguicho: 1, qtdStorz: 1 },
            { id: "H15-15",    numero: 15,    edificacao: "LADO AR",        descricao: "Externa desembarque",             qtdMangueiras: 4, tipoMangueira: "2", tamanhoMangueira: 15, polegadaMangueira: '2½"', tipoEsguicho: "Agulheta",  qtdEsguicho: 1, qtdStorz: 1 },
            { id: "H16-16",    numero: 16,    edificacao: "PÁTIO 1",        descricao: "Posição 7",                       qtdMangueiras: 4, tipoMangueira: "2", tamanhoMangueira: 15, polegadaMangueira: '2½"', tipoEsguicho: "Agulheta",  qtdEsguicho: 1, qtdStorz: 1 },
            { id: "H17-17",    numero: 17,    edificacao: "LADO AR",        descricao: "Refeitório APOC",                 qtdMangueiras: 2, tipoMangueira: "2", tamanhoMangueira: 15, polegadaMangueira: '2½"', tipoEsguicho: "Agulheta",  qtdEsguicho: 1, qtdStorz: 1 },
            { id: "H18-18",    numero: 18,    edificacao: "LADO AR",        descricao: "Entrada RP",                      qtdMangueiras: 3, tipoMangueira: "2", tamanhoMangueira: 15, polegadaMangueira: '1½"', tipoEsguicho: "Agulheta",  qtdEsguicho: 1, qtdStorz: 1 },
            { id: "H19-19",    numero: 19,    edificacao: "SCI",            descricao: "Garagem SCI",                     qtdMangueiras: 2, tipoMangueira: "2", tamanhoMangueira: 15, polegadaMangueira: '2½"', tipoEsguicho: "Agulheta",  qtdEsguicho: 1, qtdStorz: 1 },
            { id: "H20-20",    numero: 20,    edificacao: "SCI",            descricao: "Academia SCI",                    qtdMangueiras: 2, tipoMangueira: "2", tamanhoMangueira: 15, polegadaMangueira: '1½"', tipoEsguicho: "Agulheta",  qtdEsguicho: 1, qtdStorz: 1 },
            { id: "H21-21",    numero: 21,    edificacao: "SCI SUPERIOR",   descricao: "Almoxarifado Motiva",             qtdMangueiras: 2, tipoMangueira: "2", tamanhoMangueira: 15, polegadaMangueira: '2½"', tipoEsguicho: "Agulheta",  qtdEsguicho: 1, qtdStorz: 1 },
            { id: "H22-22",    numero: 22,    edificacao: "INOPERANTE",     descricao: "-",                               qtdMangueiras: 0, tipoMangueira: "-", tamanhoMangueira: 0,  polegadaMangueira: '0',   tipoEsguicho: "-",         qtdEsguicho: 0, qtdStorz: 0 },
        ];
        
        // Estrutura para as configurações dinâmicas de mangueira
        const MANGUEIRA_CONFIG_OPTIONS = {
            tipo: [{ label: 'Tipo 2', value: 2 }, { label: 'Tipo 3', value: 3 }, { label: 'Tipo 4', value: 4 }],
            tamanho: [{ label: '15 metros', value: 15 }, { label: '20 metros', value: 20 }, { label: '30 metros', value: 30 }],
            polegada: [{ label: '1½"', value: '1½"' }, { label: '2½"', value: '2½"' }],
            quantidade: [1, 2, 3, 4, 5] // Quantidade por configuração
        };

        // Variáveis de escopo
        let app, db, auth, userId = null;
        let currentHydrant = null;
        let inspectionStatus = {};
        let mangueiraConfigs = []; // Armazena as configurações dinâmicas de mangueiras

        // Elementos DOM
        const hydrantContainer = document.getElementById('hydrants-container');
        const modal = document.getElementById('inspection-modal');
        const form = document.getElementById('inspection-form');
        const detailedSection = document.getElementById('detailed-inspection-section');
        const loadingMessage = document.getElementById('loading-message');
        const modalMessage = document.getElementById('modal-message');
        const submitButton = form.querySelector('button[type="submit"]');
        const loadingSpinner = document.getElementById('loading-spinner');
        const submitText = document.getElementById('submit-text');
        const resetBtn = document.getElementById('reset-status-btn');

        // --- Funções de Ajuda ---

        /**
         * Converte um objeto de dados de inspeção em uma string CSV para o App Script.
         * @param {Object} data - Objeto contendo todos os dados da vistoria.
         * @returns {string} - String formatada para envio.
         */
        function formatDataForAppScript(data) {
            
            // 1. Cria o resumo das mangueiras (Mang. Adicionais)
            const mangueirasSummary = data.mangueirasAdicionadas.map(cfg => {
                // cfg.quantidade já deve ser um número > 0 devido ao filtro
                const quantidade = cfg.quantidade;
                
                // O cálculo da quantidade total de mangueiras é: Qtd * Tipo (2, 3 ou 4). Usa 1 se o tipo não for selecionado ('-').
                const tipoValue = parseInt(cfg.tipo.value) || 1; 
                const total = quantidade * tipoValue; 
                
                // Formatação robusta: usa ?? se o campo não foi preenchido ('-')
                const tipoLabel = cfg.tipo.value !== '-' ? `Tipo${cfg.tipo.value}` : 'Tipo_??';
                const tamanhoLabel = cfg.tamanho.value !== '-' ? `${cfg.tamanho.value}m` : '??m';
                const polegadaLabel = cfg.polegada.value !== '-' ? `${cfg.polegada.value}"` : '??"';

                return `${quantidade}x ${tipoLabel} de ${tamanhoLabel} com ${polegadaLabel}`;
            }).join(' + ');

            // 2. Calcula a quantidade total (raw) de mangueiras (soma das quantidades brutas)
            const totalRawMangueiras = data.mangueirasAdicionadas.reduce((sum, cfg) => sum + (Number(cfg.quantidade) || 0), 0);

            // Define o valor padrão para os campos não respondidos como '-'
            const getFormValue = (key, defaultValue = '-') => data[key] === undefined ? defaultValue : data[key];
            const getSelectValue = (key) => getFormValue(key, '-');


            const fields = [
                data.hidrante.numero,
                data.hidrante.edificacao,
                data.hidrante.descricao,
                data.hidrante.qtdMangueiras,
                data.hidrante.tipoMangueira,
                `${data.hidrante.tamanhoMangueira}m`,
                data.hidrante.polegadaMangueira,
                data.hidrante.tipoEsguicho,
                data.hidrante.qtdEsguicho,
                data.hidrante.qtdStorz,
                getSelectValue('q0_1_sinalizacao'),
                getSelectValue('q0_2_lacrado'),
                getSelectValue('q1_mangueiras_conforme'),
                mangueirasSummary || '-', // 16: Configurações de mangueiras (Resumo). CORRIGIDO: Se vazio, mostra '-'.
                totalRawMangueiras,        // 17: Quantidade total de mangueiras adicionadas (Raw). CORRIGIDO: Se 0, mostra '0'.
                getSelectValue('q2_teste_hidrostatico'),
                getSelectValue('q3_esguicho_presente'),
                getSelectValue('q3_1_tipo_esguicho'),
                getSelectValue('q4_storz_presente'),
                getSelectValue('q4_1_quantidade_storz'),
                getSelectValue('q5_itens_conformidade'),
                getFormValue('q6_observacao'),
                getSelectValue('q7_equipe'),
                getFormValue('nomeVistoriador'),
                new Date(data.timestamp).toLocaleString('pt-BR'),
            ];
            
            // Retorna o objeto no formato key-value esperado pelo App Script
            return { data: fields.join(';') };
        }

        // --- Lógica do Formulário Dinâmico ---

        /**
         * Renderiza uma nova seção de configuração de mangueira no modal.
         */
        window.addMangueiraConfig = () => {
            if (mangueiraConfigs.length >= 4) {
                showMessage("Limite de 4 configurações de mangueira atingido.", 'bg-red-100 text-red-700');
                return;
            }

            const configIndex = mangueiraConfigs.length;
            const configId = `config-${currentHydrant.id}-${configIndex}`;

            // Define os valores iniciais como '-' para selects e 0 para quantidade
            const newConfig = {
                id: configId,
                tipo: { value: '-', label: 'Selecione' },
                tamanho: { value: '-', label: 'Selecione' },
                polegada: { value: '-', label: 'Selecione' },
                quantidade: 0 // Valor inicial (será filtrado se permanecer 0)
            };
            mangueiraConfigs.push(newConfig);

            const container = document.getElementById('mangueira-configs-list');
            const div = document.createElement('div');
            div.id = configId;
            div.className = 'p-4 border border-gray-300 rounded-lg bg-white space-y-3';
            
            let html = `
                <div class="flex justify-between items-center">
                    <h5 class="font-bold text-sm text-indigo-700">Configuração ${configIndex + 1}</h5>
                    <button type="button" onclick="removeMangueiraConfig('${configId}')" class="text-red-500 hover:text-red-700 text-sm">Remover</button>
                </div>
                <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 items-end">
                    <!-- 1.1 - Tipo -->
                    <div>
                        <label class="block text-xs font-medium text-gray-700">1.1 - Tipo (2, 3 ou 4)</label>
                        <select name="${configId}_tipo" data-config-id="${configId}" data-field="tipo" onchange="updateMangueiraConfig('${configId}', 'tipo', this.value, this.options[this.selectedIndex].text)" class="w-full px-3 py-1 border border-gray-300 rounded-lg text-sm">
                            <option value="-">Selecione</option>
                            ${MANGUEIRA_CONFIG_OPTIONS.tipo.map(opt => `<option value="${opt.value}">${opt.label}</option>`).join('')}
                        </select>
                    </div>
                    <!-- 1.2 - Tamanho -->
                    <div>
                        <label class="block text-xs font-medium text-gray-700">1.2 - Tamanho (m)</label>
                        <select name="${configId}_tamanho" data-config-id="${configId}" data-field="tamanho" onchange="updateMangueiraConfig('${configId}', 'tamanho', this.value, this.options[this.selectedIndex].text)" class="w-full px-3 py-1 border border-gray-300 rounded-lg text-sm">
                            <option value="-">Selecione</option>
                            ${MANGUEIRA_CONFIG_OPTIONS.tamanho.map(opt => `<option value="${opt.value}">${opt.label}</option>`).join('')}
                        </select>
                    </div>
                    <!-- 1.3 - Polegada -->
                    <div>
                        <label class="block text-xs font-medium text-gray-700">1.3 - Polegada</label>
                        <select name="${configId}_polegada" data-config-id="${configId}" data-field="polegada" onchange="updateMangueiraConfig('${configId}', 'polegada', this.value, this.options[this.selectedIndex].text)" class="w-full px-3 py-1 border border-gray-300 rounded-lg text-sm">
                            <option value="-">Selecione</option>
                            ${MANGUEIRA_CONFIG_OPTIONS.polegada.map(opt => `<option value="${opt.value}">${opt.label}</option>`).join('')}
                        </select>
                    </div>
                    <!-- Quantidade -->
                    <div>
                        <label class="block text-xs font-medium text-gray-700">Qtd. Mangueiras (1-5)</label>
                        <select name="${configId}_quantidade" data-config-id="${configId}" data-field="quantidade" onchange="updateMangueiraConfig('${configId}', 'quantidade', this.value, this.options[this.selectedIndex].text)" class="w-full px-3 py-1 border border-gray-300 rounded-lg text-sm">
                            <option value="">Qtd</option> <!-- CORREÇÃO AQUI: Valor Vazio para forçar seleção -->
                            ${MANGUEIRA_CONFIG_OPTIONS.quantidade.map(qty => `<option value="${qty}">${qty}</option>`).join('')}
                        </select>
                    </div>
                </div>
            `;
            
            div.innerHTML = html;
            container.appendChild(div);
        };

        /**
         * Remove uma seção de configuração de mangueira.
         * @param {string} configId - ID da configuração a ser removida.
         */
        window.removeMangueiraConfig = (configId) => {
            const index = mangueiraConfigs.findIndex(cfg => cfg.id === configId);
            if (index > -1) {
                mangueiraConfigs.splice(index, 1);
                document.getElementById(configId)?.remove();
                // Renomeia os títulos restantes
                document.querySelectorAll('#mangueira-configs-list > div').forEach((el, i) => {
                    el.querySelector('h5').textContent = `Configuração ${i + 1}`;
                });
            }
        };

        /**
         * Atualiza os dados de uma configuração de mangueira.
         */
        window.updateMangueiraConfig = (configId, field, value, label) => {
            const config = mangueiraConfigs.find(cfg => cfg.id === configId);
            if (!config) return;

            if (field === 'quantidade') {
                // CORREÇÃO AQUI: Usa Number() e fallback para 0 se for NaN (string vazia ou inválida)
                config.quantidade = Number(value) || 0; 
            } else {
                // Guarda o valor e o label para selects
                config[field] = { value: String(value), label: label };
            }
        };

        /**
         * Alterna a visibilidade da seção de configurações de mangueira (Q1).
         */
        window.toggleMangueirasConfig = () => {
            const isNao = form.querySelector('input[name="q1_mangueiras_conforme"][value="Não"]:checked');
            const dynamicConfig = document.getElementById('mangueiras-dynamic-config');
            
            if (isNao) {
                dynamicConfig.classList.remove('hidden');
                // Adiciona a primeira configuração se não houver nenhuma
                if (mangueiraConfigs.length === 0) {
                    addMangueiraConfig();
                }
            } else {
                dynamicConfig.classList.add('hidden');
                // Limpa as configurações se o usuário selecionar "Sim"
                mangueiraConfigs = [];
                document.getElementById('mangueira-configs-list').innerHTML = '';
            }
        };

        /**
         * Alterna a visibilidade da seção de inspeção detalhada (Q1 a Q4) baseada em Q0.2.
         */
        window.toggleDetailedInspection = () => {
            const isNotSealed = form.querySelector('input[name="q0_2_lacrado"][value="Não"]:checked');
            if (isNotSealed) {
                detailedSection.classList.remove('hidden');
                // Força a atualização de Q1 (caso tenha estado 'Não' antes)
                toggleMangueirasConfig(); 
            } else {
                detailedSection.classList.add('hidden');
                // Reset Q1-Q4 if hidden
                form.querySelectorAll('#detailed-inspection-section input[type="radio"]').forEach(radio => radio.checked = false);
                toggleMangueirasConfig(); // Esconde e limpa configurações de mangueira
                toggleEsguichoType(); // Esconde subpergunta do esguicho
                toggleStorzQuantity(); // Esconde subpergunta do Storz
            }
        };

        /**
         * Alterna a visibilidade da subpergunta de Tipo de Esguicho (Q3.1).
         */
        window.toggleEsguichoType = () => {
            const isPresent = form.querySelector('input[name="q3_esguicho_presente"][value="Sim"]:checked');
            document.getElementById('q3_1_tipo_esguicho_container').classList.toggle('hidden', !isPresent);
        };

        /**
         * Alterna a visibilidade da subpergunta de Quantidade de Storz (Q4.1).
         */
        window.toggleStorzQuantity = () => {
            const isPresent = form.querySelector('input[name="q4_storz_presente"][value="Sim"]:checked');
            document.getElementById('q4_1_quantidade_storz_container').classList.toggle('hidden', !isPresent);
        };

        // --- Lógica do Modal ---

        /**
         * Abre o modal de inspeção.
         * @param {string} hydrantId - ID do hidrante selecionado.
         */
        window.openModal = (hydrantId) => {
            const inspectorName = document.getElementById('inspector-name').value.trim();
            if (!inspectorName) {
                showMessageBox("Por favor, preencha o campo **Seu Nome para a Vistoria** antes de iniciar a inspeção.", 'bg-red-100 text-red-700');
                return;
            }

            currentHydrant = HYDRANT_DATA.find(h => h.id === hydrantId);
            if (!currentHydrant) {
                showMessageBox("Erro: Hidrante não encontrado.", 'bg-red-100 text-red-700');
                return;
            }
            
            // Limpar/Resetar o formulário
            form.reset();
            mangueiraConfigs = []; // Resetar configurações dinâmicas
            document.getElementById('mangueira-configs-list').innerHTML = '';
            detailedSection.classList.add('hidden'); // Esconder a seção detalhada
            document.getElementById('q3_1_tipo_esguicho_container').classList.add('hidden');
            document.getElementById('q4_1_quantidade_storz_container').classList.add('hidden');
            document.getElementById('mangueiras-dynamic-config').classList.add('hidden');
            modalMessage.classList.add('hidden'); // Esconder mensagem do modal

            // Preencher informações do modal
            document.getElementById('modal-title').textContent = `Hidrante: ${currentHydrant.numero} - ${currentHydrant.edificacao}`;
            document.getElementById('modal-description').textContent = currentHydrant.descricao;

            // Atualizar o texto da Q1 com os dados do hidrante
            const q1Title = document.getElementById('q1-title');
            q1Title.textContent = `1 - Possui ${currentHydrant.qtdMangueiras} mangueiras do tipo ${currentHydrant.tipoMangueira} de ${currentHydrant.tamanhoMangueira} metros de ${currentHydrant.polegadaMangueira}?`;

            modal.style.display = 'flex';
        };

        /**
         * Fecha o modal de inspeção e reseta o hidrante atual.
         */
        window.closeModal = () => {
            modal.style.display = 'none';
            currentHydrant = null;
            modalMessage.classList.add('hidden');
        };

        // --- Lógica de Sincronização e Estado ---

        /**
         * Inicializa o Firebase e a autenticação.
         */
        async function initializeFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Autenticação com o token customizado ou anônima
                await new Promise(resolve => {
                    onAuthStateChanged(auth, async (user) => {
                        if (!user) {
                            if (initialAuthToken) {
                                await signInWithCustomToken(auth, initialAuthToken);
                            } else {
                                await signInAnonymously(auth);
                            }
                        }
                        userId = auth.currentUser?.uid || crypto.randomUUID();
                        document.getElementById('auth-info').textContent = `Usuário (ID): ${userId.substring(0, 8)}...`;
                        resolve();
                    });
                });
                
                // Renderizar a lista de hidrantes e iniciar a escuta
                renderHydrantButtons();
                setupRealtimeListener();

            } catch (error) {
                console.error("Erro ao inicializar Firebase:", error);
                loadingMessage.textContent = "Erro ao carregar o aplicativo. Verifique o console para mais detalhes.";
            }
        }

        /**
         * Renderiza os botões dos hidrantes no container.
         */
        function renderHydrantButtons() {
            hydrantContainer.innerHTML = '';
            HYDRANT_DATA.forEach(hydrant => {
                const btn = document.createElement('button');
                btn.id = `btn-${hydrant.id}`;
                btn.className = 'hydrant-btn not-inspected p-4 rounded-xl text-left font-semibold hover:bg-blue-700 transition duration-150 ease-in-out';
                btn.setAttribute('onclick', `openModal('${hydrant.id}')`);
                
                btn.innerHTML = `
                    <div class="text-2xl font-extrabold">H ${hydrant.numero}</div>
                    <div class="text-sm font-medium opacity-90">${hydrant.edificacao}</div>
                    <div class="status text-xs mt-1 font-light italic">Não vistoriado</div>
                `;
                hydrantContainer.appendChild(btn);
            });
            loadingMessage.classList.add('hidden');
        }

        /**
         * Configura o listener em tempo real no Firestore.
         */
        function setupRealtimeListener() {
            if (!db) return;
            const collectionPath = `/artifacts/${appId}/public/data/inspecoesHidrantes`;
            const q = query(collection(db, collectionPath));

            onSnapshot(q, (snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    const data = change.doc.data();
                    const hydrantId = data.hidranteId;
                    inspectionStatus[hydrantId] = data;
                    updateHydrantButton(hydrantId, data);
                });
            }, (error) => {
                console.error("Erro no listener do Firestore:", error);
            });
        }

        /**
         * Atualiza o visual do botão do hidrante.
         * @param {string} hydrantId - ID do hidrante.
         * @param {Object} status - Dados de status do hidrante.
         */
        function updateHydrantButton(hydrantId, status) {
            const btn = document.getElementById(`btn-${hydrantId}`);
            if (btn) {
                const statusDiv = btn.querySelector('.status');
                if (status.isVistoriado) {
                    btn.classList.remove('not-inspected');
                    btn.classList.add('inspected');
                    const date = new Date(status.timestamp).toLocaleDateString('pt-BR');
                    const time = new Date(status.timestamp).toLocaleTimeString('pt-BR');
                    statusDiv.innerHTML = `Vistoriado por: <span class="font-bold">${status.vistoriador}</span><br>em ${date} às ${time}`;
                } else {
                    btn.classList.remove('inspected');
                    btn.classList.add('not-inspected');
                    statusDiv.textContent = 'Não vistoriado';
                }
            }
        }

        // --- Lógica de Envio ---
        
        /**
         * Envia os dados da inspeção para o Google Apps Script.
         * @param {Object} dataToSend - Dados da inspeção formatados.
         */
        async function sendToAppScript(dataToSend) {
            // Implementa a lógica de backoff exponencial
            const MAX_RETRIES = 3;
            for (let i = 0; i < MAX_RETRIES; i++) {
                try {
                    const queryParams = new URLSearchParams(dataToSend).toString();
                    const url = `${APP_SCRIPT_URL}?${queryParams}`;
                    
                    const response = await fetch(url, {
                        method: 'GET',
                        mode: 'no-cors'
                    });
                    
                    return { success: true };

                } catch (error) {
                    if (i < MAX_RETRIES - 1) {
                        const delay = Math.pow(2, i) * 1000; // 1s, 2s, 4s
                        await new Promise(resolve => setTimeout(resolve, delay));
                    } else {
                        console.error("Erro fatal após múltiplas tentativas ao enviar dados para o App Script:", error);
                        return { success: false, error: "Falha na comunicação com o App Script." };
                    }
                }
            }
        }

        /**
         * Lida com a submissão do formulário.
         */
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // Ativar loading
            setLoading(true);

            if (!currentHydrant || !db) {
                showMessage("Erro: Hidrante ou conexão com o banco de dados inválida.", 'bg-red-100 text-red-700');
                setLoading(false);
                return;
            }

            const inspectorName = document.getElementById('inspector-name').value.trim();
            if (!inspectorName) {
                showMessage("Erro: Nome do vistoriador não preenchido.", 'bg-red-100 text-red-700');
                setLoading(false);
                return;
            }

            // 1. Coletar dados do formulário
            const formData = new FormData(form);
            const data = {
                hidrante: currentHydrant,
                nomeVistoriador: inspectorName,
                timestamp: Date.now(),
                mangueirasAdicionadas: [],
            };

            // Preenche os dados do formulário, tratando valores não dinâmicos de mangueira
            for (let [key, value] of formData.entries()) {
                if (key.startsWith('config-')) continue; 
                data[key] = value || '-';
            }

            // 2. Coletar dados de mangueiras dinâmicas (apenas se Q1='Não')
            const isMangueirasNaoConforme = data['q1_mangueiras_conforme'] === 'Não';
            
            if (isMangueirasNaoConforme) {
                // Filtra a configuração APENAS se a QUANTIDADE for estritamente maior que 0.
                data.mangueirasAdicionadas = mangueiraConfigs.filter(cfg => 
                    cfg.quantidade > 0 
                ).map(cfg => {
                    return {
                        tipo: cfg.tipo,
                        tamanho: cfg.tamanho,
                        polegada: cfg.polegada,
                        quantidade: cfg.quantidade
                    };
                });
            } else {
                 // Se Q1='Sim', as configurações adicionadas devem ser ignoradas.
                 data.mangueirasAdicionadas = [];
            }
            
            // 3. Preparar dados de status para o Firestore
            const statusUpdate = {
                hidranteId: currentHydrant.id,
                isVistoriado: true,
                vistoriador: inspectorName,
                timestamp: data.timestamp,
                data: JSON.stringify(data) // Salva os dados completos como JSON string
            };

            // 4. Enviar para App Script (Planilha Google)
            const appScriptData = formatDataForAppScript(data);
            const appScriptResult = await sendToAppScript(appScriptData);
            
            if (!appScriptResult.success) {
                // NOTA: Continuamos salvando no Firebase mesmo com falha na planilha
                showMessage("AVISO: Status salvo no Firebase, mas **falha no envio para a Planilha Google**.", 'bg-yellow-100 text-yellow-700');
            }

            // 5. Salvar Status no Firestore
            try {
                const docRef = doc(db, `/artifacts/${appId}/public/data/inspecoesHidrantes`, `hidrante_${currentHydrant.id}`);
                await setDoc(docRef, statusUpdate);
                if (appScriptResult.success) {
                    showMessage("Inspeção enviada com sucesso! O status do hidrante foi atualizado.", 'bg-green-100 text-green-700');
                }
                
                // Fechar modal após pequeno atraso para o usuário ver a mensagem
                setTimeout(() => {
                    closeModal();
                }, 1500);

            } catch (firestoreError) {
                console.error("Erro ao salvar no Firestore:", firestoreError);
                showMessage("Erro ao salvar no Firebase. Verifique sua conexão e tente novamente.", 'bg-red-100 text-red-700');
            }

            // Desativar loading
            setLoading(false);
        });

        // --- Lógica de Reset ---

        /**
         * Reseta o status de todos os hidrantes no Firestore.
         */
        resetBtn.addEventListener('click', async () => {
            if (!db) return showMessageBox("Sistema não inicializado.", 'bg-red-100 text-red-700');
            
            const confirmation = window.prompt("Tem certeza que deseja RESETAR O STATUS de todos os hidrantes? Digite 'RESETAR' para confirmar.");
            
            if (confirmation !== 'RESETAR') {
                showMessageBox("Ação de reset cancelada.", 'bg-yellow-100 text-yellow-700');
                return;
            }

            resetBtn.disabled = true;
            resetBtn.textContent = 'Resetando...';
            
            try {
                const batch = writeBatch(db);
                const collectionPath = `/artifacts/${appId}/public/data/inspecoesHidrantes`;
                const q = query(collection(db, collectionPath));
                
                // Usamos getDocs para pegar os documentos que serão deletados
                const snapshot = await getDocs(q);

                if (snapshot.empty) {
                    showMessageBox("Nenhum status para resetar. Tudo limpo!", 'bg-blue-100 text-blue-700');
                    resetBtn.disabled = false;
                    resetBtn.textContent = 'Resetar Status dos Hidrantes (Nova Ronda)';
                    return;
                }

                snapshot.docs.forEach(doc => {
                    batch.delete(doc.ref);
                });

                await batch.commit();

                // Resetar o estado local e visual (onSnapshot deve cuidar disso, mas fazemos preventivamente)
                HYDRANT_DATA.forEach(h => updateHydrantButton(h.id, { isVistoriado: false }));
                inspectionStatus = {};
                showMessageBox("Status de todos os hidrantes resetado com sucesso! Nova ronda iniciada.", 'bg-green-100 text-green-700');

            } catch (error) {
                console.error("Erro ao resetar status:", error);
                showMessageBox("Erro ao resetar. Verifique o console.", 'bg-red-100 text-red-700');
            } finally {
                resetBtn.disabled = false;
                resetBtn.textContent = 'Resetar Status dos Hidrantes (Nova Ronda)';
            }
        });

        // --- Funções de UI ---

        /**
         * Exibe uma mensagem dentro do modal.
         */
        function showMessage(text, className) {
            modalMessage.textContent = text;
            modalMessage.className = `mt-4 text-center p-2 rounded-lg ${className}`;
            modalMessage.classList.remove('hidden');
        }

        /**
         * Exibe uma mensagem de notificação na tela principal. (Custom Alert/Confirm substitute)
         */
        function showMessageBox(text, className) {
            const box = document.createElement('div');
            box.className = `col-span-full fixed top-4 right-4 p-4 rounded-xl shadow-xl font-medium ${className} z-50 transition-transform transform translate-x-0`;
            box.textContent = text;
            document.body.appendChild(box);
            
            setTimeout(() => {
                box.classList.add('translate-x-full');
                box.classList.add('opacity-0');
                setTimeout(() => box.remove(), 500);
            }, 5000);
        }

        /**
         * Controla o estado de loading do botão de envio.
         */
        function setLoading(isLoading) {
            submitButton.disabled = isLoading;
            loadingSpinner.classList.toggle('hidden', !isLoading);
            submitText.classList.toggle('hidden', isLoading);
        }


        // Inicializar o aplicativo quando o script for carregado
        window.onload = initializeFirebase;

    </script>
</body>
</html>
