<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Ronda de Hidrantes V2</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, setPersistence, browserSessionPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, query, writeBatch, deleteDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Define as configurações globais (obrigatórias pelo ambiente)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyCInOMNcg0PEd2EJGgkGXk2QOp1HHPjMsw",
            authDomain: "ronda-hidrantes.firebaseapp.com",
            projectId: "ronda-hidrantes",
            storageBucket: "ronda-hidrantes.firebasestorage.app",
            messagingSenderId: "599277880651",
            appId: "1:599277880651:web:5a440d1a2ad1bb36ea14ce"
        };
        
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Inicializa o Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        // Define o nível de log para debug no console (útil para rastrear o Firestore)
        setLogLevel('Debug');

        // Variáveis de estado global
        window.db = db;
        window.auth = auth;
        window.appId = appId;
        window.userId = null;
        window.userName = '';
        window.inspecoes = {};
        window.currentHydrant = null;
        window.maxMangueiras = 4; // Máximo de slots de mangueira para configurações de não-conformidade
        
        // ** CONFIGURAÇÃO ESSENCIAL: COLE A URL DO SEU APP SCRIPT AQUI **
        // ATENÇÃO: Se você vir "TypeError: Failed to fetch" no console, essa URL está incorreta ou o script não foi implantado.
        const GOOGLE_SHEET_URL = 'https://script.google.com/macros/s/AKfycbwksfD950JmBocClzZT2a0kAbllQINzVDb0qeHj6BCVHrxUloEfb2zbweQaLenXb2BX/exec';

        // Dados estáticos dos hidrantes (AGORA COM ESGUICHO E CHAVE STORZ)
        window.hidrantesData = [
            { id: 'H01', edificacao: 'Principal', descricao: 'Próximo à portaria A', qtdeMangueiras: 2, tipo: '2', tamanho: 15, polegada: '2 1/2"', qtdeChaveStorz: 2, qtdeEsguicho: 1, tipoEsguicho: 'Regulável' },
            { id: 'H02', edificacao: 'Principal', descricao: 'Corredor Leste, 1º Andar', qtdeMangueiras: 1, tipo: '3', tamanho: 20, polegada: '1 1/2"', qtdeChaveStorz: 1, qtdeEsguicho: 1, tipoEsguicho: 'Agulheta' },
            { id: 'H03', edificacao: 'Anexo B', descricao: 'Pátio de Cargas', qtdeMangueiras: 3, tipo: '2', tamanho: 30, polegada: '2 1/2"', qtdeChaveStorz: 2, qtdeEsguicho: 2, tipoEsguicho: 'Regulável' },
            { id: 'H04', edificacao: 'Principal', descricao: 'Estacionamento Inferior', qtdeMangueiras: 2, tipo: '4', tamanho: 15, polegada: '1 1/2"', qtdeChaveStorz: 1, qtdeEsguicho: 1, tipoEsguicho: 'Agulheta' },
            { id: 'H05', edificacao: 'Administrativo', descricao: 'Recepção', qtdeMangueiras: 1, tipo: '2', tamanho: 20, polegada: '2 1/2"', qtdeChaveStorz: 1, qtdeEsguicho: 0, tipoEsguicho: 'N/A' },
            { id: 'H06', edificacao: 'Galpão A', descricao: 'Canto Norte', qtdeMangueiras: 2, tipo: '3', tamanho: 25, polegada: '2 1/2"', qtdeChaveStorz: 2, qtdeEsguicho: 1, tipoEsguicho: 'Regulável' },
            { id: 'H07', edificacao: 'Galpão B', descricao: 'Próximo Doca 3', qtdeMangueiras: 1, tipo: '2', tamanho: 15, polegada: '1 1/2"', qtdeChaveStorz: 1, qtdeEsguicho: 1, tipoEsguicho: 'Agulheta' },
        ];

        // 1. Funções de Autenticação e Inicialização
        async function setupAuthAndFirestore() {
            try {
                await setPersistence(auth, browserSessionPersistence);
                
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                    console.log("Autenticação: Login realizado via Custom Token (Ambiente Canvas).");
                } else {
                    await signInAnonymously(auth);
                    console.log("Autenticação: Login anônimo realizado com sucesso.");
                }
            } catch (error) {
                console.error("Erro na autenticação Firebase:", error);
                if (error.code === 'auth/configuration-not-found') {
                    console.error("ATENÇÃO: Habilite o método de login 'Anônimo' no Console do Firebase.");
                }
                return;
            }

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    window.userId = user.uid;
                    startRealtimeListener();
                } else {
                    console.log("Usuário deslogado. Firebase Auth falhou ou não foi inicializado.");
                }
            });
        }

        // 2. Caminho da Coleção (Público)
        function getInspecoesCollectionPath() {
            return `artifacts/${appId}/public/data/inspecoesHidrantes`;
        }

        // 3. Listener em Tempo Real
        function startRealtimeListener() {
            const path = getInspecoesCollectionPath();
            const q = query(collection(db, path));

            onSnapshot(q, (snapshot) => {
                const newInspecoes = {};
                snapshot.forEach((doc) => {
                    newInspecoes[doc.id] = doc.data();
                });
                window.inspecoes = newInspecoes;
                renderHydrantButtons();
            }, (error) => {
                console.error("Erro ao ouvir em tempo real:", error);
            });
        }

        // 4. Renderização dos Botões (Mantido)
        window.renderHydrantButtons = function() {
            const container = document.getElementById('hydrant-container');
            if (!container) return;

            container.innerHTML = ''; 

            window.hidrantesData.forEach(hidrante => {
                const docId = hidrante.id;
                const inspecao = window.inspecoes[docId];
                
                let buttonClass = 'bg-blue-600 hover:bg-blue-700';
                let buttonText = `${hidrante.id} - ${hidrante.edificacao}`;
                let icon = '';

                if (inspecao && inspecao.status === 'vistoriado') {
                    buttonClass = 'bg-green-600 hover:bg-green-700';
                    buttonText = `${hidrante.id} - ${hidrante.edificacao} | Vistoriado por: ${inspecao.vistoriador}`;
                    icon = '<svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>';
                }

                const button = document.createElement('button');
                button.className = `hydrant-button ${buttonClass} text-white font-bold py-3 px-4 rounded-xl shadow-lg transition duration-150 ease-in-out flex items-center justify-center text-left transform hover:scale-[1.02]`;
                button.innerHTML = `${icon} <span>${buttonText}</span>`;
                button.onclick = () => window.openModal(hidrante.id);

                container.appendChild(button);
            });
        }

        // 5. Função para Abrir o Modal (ATUALIZADA com novas perguntas)
        window.openModal = function(hidranteId) {
            window.userName = document.getElementById('inspector-name').value.trim();
            const modal = document.getElementById('inspection-modal');
            const hydrant = window.hidrantesData.find(h => h.id === hidranteId);

            if (!window.userName) {
                window.showMessage('Preencha o campo **NOME** do Vistoriador antes de iniciar a inspeção!', 'bg-yellow-100 border-yellow-400 text-yellow-700');
                document.getElementById('inspector-name').focus();
                return;
            }

            if (!hydrant) return;

            window.currentHydrant = hydrant;
            document.getElementById('modal-title').textContent = `Hidrante ${hidranteId}`;
            document.getElementById('modal-description').textContent = hydrant.descricao;
            
            // Pergunta 1
            document.getElementById('mangueiras-pergunta').innerHTML = `1- Possui ${hydrant.qtdeMangueiras} mangueiras do tipo ${hydrant.tipo} de ${hydrant.tamanho} metros de ${hydrant.polegada}?`;
            
            // Pergunta 2.1 (Usa dados estáticos)
            document.getElementById('subpergunta2-1-label').innerHTML = `2.1- Possui ${hydrant.qtdeEsguicho} do tipo ${hydrant.tipoEsguicho} (Esperado)?`;
            
            // Pergunta 3 (Usa dados estáticos)
            document.getElementById('pergunta3-label').innerHTML = `3- Possui ${hydrant.qtdeChaveStorz} Chave Storz (Esperado)?`;

            // Resetar o formulário e o estado, e garantir que a seção completa de inspeção esteja oculta inicialmente
            window.resetForm();
            document.getElementById('full-inspection-section').classList.add('hidden');
            
            modal.classList.remove('hidden');
        }
        
        // 6. Função para Fechar o Modal (Mantido)
        window.closeModal = function() {
            document.getElementById('inspection-modal').classList.add('hidden');
            window.currentHydrant = null;
            window.resetForm();
        }

        // 7. Funções do Formulário Dinâmico de Mangueiras (Mantido)
        window.mangueiraConfigs = []; // Array de configurações: { id: N, qty: N, tipo: '...', tamanho: '...', polegada: '...' }
        window.configCounter = 0; // Contador para IDs únicos
        
        // Adiciona uma nova configuração (até o limite de 4)
        window.addMangueiraConfig = function() {
            if (window.mangueiraConfigs.length >= window.maxMangueiras) {
                window.showMessage(`Máximo de ${window.maxMangueiras} configurações de não-conformidade permitidas.`, 'bg-yellow-100 border-yellow-400 text-yellow-700');
                return;
            }

            window.configCounter++;
            const newConfig = {
                id: window.configCounter,
                qty: 1, // Começa com 1
                'tipo-m': '-',
                'tamanho-m': '-',
                'polegada-m': '-'
            };
            window.mangueiraConfigs.push(newConfig);
            window.renderMangueiraDetailsForm();
        }
        
        /**
         * Renderiza o formulário de detalhes de mangueiras com o seletor de quantidade integrado.
         */
        window.renderMangueiraDetailsForm = function() {
            const container = document.getElementById('mangueiras-details-container');
            const templateContent = document.getElementById('mangueira-template').content;
            
            container.innerHTML = ''; 
            
            window.mangueiraConfigs.forEach((config, index) => {
                const configElement = document.createElement('div');
                configElement.id = `config-${config.id}`;
                
                const clone = templateContent.cloneNode(true);
                const formGroup = clone.querySelector('.mangueira-fields');

                // Adicionar título da configuração
                const title = document.createElement('h4');
                title.className = 'text-lg font-bold text-red-700 pt-2 border-t border-red-200 mt-4';
                title.textContent = `Configuração ${index + 1}`;
                if (index > 0) {
                     formGroup.prepend(title);
                }

                // Configura os campos do formulário
                const fields = formGroup.querySelectorAll('select');
                
                fields.forEach(field => {
                    const key = field.name; 
                    
                    // Define o valor inicial
                    if (key === 'qty-m') {
                        field.value = config.qty.toString();
                    } else {
                        field.value = config[key];
                    }
                    
                    // Adiciona o listener para atualizar o estado do item específico
                    field.onchange = (e) => {
                        const value = e.target.value;
                        
                        // Encontra o item de configuração no array pelo ID
                        const targetConfig = window.mangueiraConfigs.find(c => c.id === config.id);

                        if (key === 'qty-m') {
                            targetConfig.qty = parseInt(value, 10);
                        } else {
                            targetConfig[key] = value;
                        }
                    };
                });

                configElement.appendChild(formGroup);
                container.appendChild(configElement);
            });
            
            // Renderiza o botão de adicionar mais configurações (abaixo do último formulário)
            const addButton = document.getElementById('add-mangueira-btn');
            if (window.mangueiraConfigs.length < window.maxMangueiras) {
                 addButton.classList.remove('hidden');
            } else {
                 addButton.classList.add('hidden');
            }
        }

        // 8. Função de Submissão do Formulário (ATUALIZADA para novas perguntas e condicional)
        window.handleSubmit = async function() {
            if (!window.currentHydrant) return;

            const form = document.getElementById('inspection-form');
            const data = new FormData(form);
            const now = new Date();
            const hydrant = window.currentHydrant;
            
            // NOVAS PERGUNTAS 0.1 e 0.2
            const p0_1_sinalizacao_conforme = data.get('pergunta0-1') || '';
            const p0_2_lacrado = data.get('pergunta0-2') || '';
            const p6_equipe = data.get('pergunta6') || ''; // Usado na validação obrigatória
            
            // Validação básica para campos obrigatórios (Q0.1, Q0.2, Q6)
            if (!p0_1_sinalizacao_conforme || !p0_2_lacrado || !p6_equipe) {
                 window.showMessage('Preencha as perguntas 0.1, 0.2 e 6 (Equipe) antes de enviar.', 'bg-yellow-100 border-yellow-400 text-yellow-700');
                 return;
            }

            const isFullInspection = p0_2_lacrado === 'Não'; // A inspeção completa só ocorre se NÃO estiver lacrado
            
            // Calcula a quantidade total NÃO-CONFORME
            const qtdeNaoConformesReportadas = isFullInspection && data.get('pergunta1') === 'Não' 
                ? window.mangueiraConfigs.reduce((sum, config) => sum + config.qty, 0)
                : 0;
            
            const formData = {
                id: hydrant.id,
                edificacao: hydrant.edificacao,
                descricao: hydrant.descricao,
                vistoriador: window.userName,
                dataVistoria: now.toLocaleDateString('pt-BR'),
                horaVistoria: now.toLocaleTimeString('pt-BR'),
                
                // NOVAS PERGUNTAS 0
                p0_1_sinalizacao_conforme: p0_1_sinalizacao_conforme,
                p0_2_lacrado: p0_2_lacrado,
                
                // Dados estáticos ESPERADOS (sempre incluídos)
                qtdeMangueiras_esperado: hydrant.qtdeMangueiras,
                tipo_esperado: hydrant.tipo,
                tamanho_esperado: hydrant.tamanho,
                polegada_esperada: hydrant.polegada,
                qtdeChaveStorz_esperado: hydrant.qtdeChaveStorz, 
                qtdeEsguicho_esperado: hydrant.qtdeEsguicho,     
                tipoEsguicho_esperado: hydrant.tipoEsguicho,     
                
                // Pergunta 1 (Mangueiras) - Só preenche se for INSPEÇÃO COMPLETA
                p1_conforme_previsto: isFullInspection ? (data.get('pergunta1') || '-') : 'N/A (Lacrado)',
                qtdeMangueiras_nao_conformes: isFullInspection ? qtdeNaoConformesReportadas : 0, 
            };

            // Adicionar dados das configurações de não-conformidade (m1, m2, m3, m4)
            for (let i = 0; i < window.maxMangueiras; i++) {
                const config = window.mangueiraConfigs[i];
                if (isFullInspection && config && data.get('pergunta1') === 'Não' && config.qty > 0) {
                    formData[`m${i+1}_tipo`] = config['tipo-m'] || '-';
                    formData[`m${i+1}_tamanho`] = config['tamanho-m'] || '-';
                    formData[`m${i+1}_polegada`] = config['polegada-m'] || '-';
                    formData[`m${i+1}_quantidade_nao_conforme`] = config.qty;
                } else {
                    formData[`m${i+1}_tipo`] = 'N/A';
                    formData[`m${i+1}_tamanho`] = 'N/A';
                    formData[`m${i+1}_polegada`] = 'N/A';
                    formData[`m${i+1}_quantidade_nao_conforme`] = 0;
                }
            }

            // Pergunta 2 (Esguicho) - Só preenche se for INSPEÇÃO COMPLETA
            formData.p2_esguicho_presente = isFullInspection ? (data.get('pergunta2') || '-') : 'N/A (Lacrado)';

            if (isFullInspection && data.get('pergunta2') === 'Sim') {
                formData.p2_1_conforme_esperado = data.get('subpergunta2-1') || '-';

                if (data.get('subpergunta2-1') === 'Não') {
                    formData.p2_2_tipo_lancado = data.get('subpergunta2-2-tipo') || '-';
                    formData.p2_2_quantidade_lancada = data.get('subpergunta2-2-qtd') || '-';
                } else {
                    formData.p2_2_tipo_lancado = '-';
                    formData.p2_2_quantidade_lancada = '-';
                }
            } else {
                formData.p2_1_conforme_esperado = 'N/A';
                formData.p2_2_tipo_lancado = 'N/A';
                formData.p2_2_quantidade_lancada = 'N/A';
            }


            // Pergunta 3 (Chave Storz) - Só preenche se for INSPEÇÃO COMPLETA
            formData.p3_chave_storz_conforme = isFullInspection ? (data.get('pergunta3') || '-') : 'N/A (Lacrado)';

            if (isFullInspection && data.get('pergunta3') === 'Não') {
                formData.p3_1_quantidade_lancada = data.get('subpergunta3-1') || '-';
            } else {
                formData.p3_1_quantidade_lancada = 'N/A';
            }

            // Pergunta 4 (Situação Geral) - Só preenche se for INSPEÇÃO COMPLETA
            formData.p4_situacao_geral_conforme = isFullInspection ? (data.get('pergunta4') || '-') : 'N/A (Lacrado)';
            
            // Perguntas 5-6 (Sempre preenchidas)
            formData.p5_observacao = data.get('pergunta5') || '-';
            formData.p6_equipe = p6_equipe;

            try {
                // 1. Salvar no Firestore (Status e Log)
                const docRef = doc(db, getInspecoesCollectionPath(), hydrant.id);
                // O status de vistoriado agora reflete se foi uma inspeção completa ou apenas um check de lacre.
                const statusMessage = isFullInspection ? 'vistoriado (Completo)' : 'vistoriado (Lacre OK)';

                await setDoc(docRef, {
                    status: statusMessage,
                    vistoriador: window.userName,
                    timestamp: now.toISOString(),
                    log: formData // Salva todos os dados do formulário como log
                });

                // 2. Envio para o Google Sheet (App Script)
                window.sendToGoogleSheet(formData);

                // 3. Sucesso e Fechar
                window.showMessage(`Vistoria do ${hydrant.id} enviada com sucesso!`, 'bg-green-100 border-green-400 text-green-700');
                window.closeModal();

            } catch (error) {
                console.error("Erro ao salvar no Firestore:", error);
                window.showMessage(`Erro ao enviar: ${error.message}`, 'bg-red-100 border-red-400 text-red-700');
            }
        }
        
        // Função de Envio para o Google Sheet (Mantida)
        window.sendToGoogleSheet = function(data) {
            
            if (GOOGLE_SHEET_URL.includes('SUA_URL_DE_IMPLANTACAO_DEVE_VIR_AQUI')) {
                console.error("ERRO DE CONFIGURAÇÃO: Por favor, substitua a URL de placeholder pela URL real do seu Google App Script Web App.");
                window.showMessage('Erro: URL do Google Sheets não configurada! Apenas o Firestore foi atualizado.', 'bg-yellow-100 border-yellow-400 text-yellow-700');
                return;
            }

            console.log("Iniciando envio para Google Sheets via Web App...");
            
            fetch(GOOGLE_SHEET_URL, {
                method: 'POST',
                mode: 'no-cors', // Essencial para o Google App Script
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            })
            .then(() => {
                console.log('Envio ao Google Sheets concluído (Verifique a planilha)');
            })
            .catch(error => {
                console.error('Erro REAL ao enviar dados ao Google Sheets:', error);
                window.showMessage(`Erro de rede ao GS. Veja o console.`, 'bg-red-100 border-red-400 text-red-700');
            });
        }
        
        // 9. Função de Reset de Status (Mantida)
        window.handleReset = async function() {
            if (!confirm('Tem certeza que deseja RESETAR o status de VISTORIADO de TODOS os hidrantes? Esta ação é IRREVERSÍVEL.')) {
                return;
            }

            try {
                const path = getInspecoesCollectionPath();
                const q = query(collection(db, path));
                const snapshot = await getDocs(q);
                
                const batch = writeBatch(db);
                snapshot.docs.forEach((doc) => {
                    batch.delete(doc.ref); 
                });

                await batch.commit();

                window.showMessage('Status de todos os hidrantes resetado com sucesso!', 'bg-green-100 border-green-400 text-green-700');
            } catch (error) {
                console.error("Erro ao resetar status:", error);
                window.showMessage(`Erro ao resetar: ${error.message}`, 'bg-red-100 border-red-400 text-red-700');
            }
        }
        
        // 10. Funções Utilitárias e Listener de Eventos (ATUALIZADA)
        window.showMessage = function(message, classes) {
            const messageBox = document.getElementById('message-box');
            messageBox.innerHTML = message;
            messageBox.className = `p-3 rounded-xl border-2 mb-4 transition-opacity duration-300 ${classes}`;
            messageBox.classList.remove('opacity-0', 'hidden');
            setTimeout(() => messageBox.classList.add('opacity-0'), 5000);
            setTimeout(() => messageBox.classList.add('hidden'), 5500);
        }

        window.resetForm = function() {
            // Resetar o formulário HTML
            document.getElementById('inspection-form').reset();
            
            // Limpar o estado JavaScript
            window.mangueiraConfigs = []; 
            window.configCounter = 0;

            // Limpar a UI da seção condicional de Mangueira
            document.getElementById('mangueiras-details-container').innerHTML = ''; 
            document.getElementById('add-mangueira-btn').classList.add('hidden'); 

            // Esconder todas as seções condicionais, incluindo a nova seção completa (Q1-Q4)
            document.getElementById('full-inspection-section').classList.add('hidden');
            document.getElementById('sub-pergunta-2-1').classList.add('hidden');
            document.getElementById('sub-pergunta-2-2').classList.add('hidden'); 
            document.getElementById('sub-pergunta-3-1').classList.add('hidden');
            document.getElementById('mangueira-conditional-section').classList.add('hidden');
        }

        window.handleConditionalVisibility = function(event) {
            const name = event.target.name;
            const value = event.target.value;

            // NOVO: Pergunta 0.2: Hidrante Lacrado
            if (name === 'pergunta0-2') {
                const fullInspectionSection = document.getElementById('full-inspection-section');
                
                // Se NÃO lacrado, abre a seção completa de inspeção (P1-P4).
                if (value === 'Não') {
                    fullInspectionSection.classList.remove('hidden');
                } else {
                    // Se SIM lacrado, fecha a seção completa e reseta o estado de P1 e P2 para evitar dados inconsistentes
                    fullInspectionSection.classList.add('hidden');
                    
                    // Reset P1 state (mangueiras) when skipping inspection
                    window.mangueiraConfigs = []; 
                    window.configCounter = 0;
                    document.getElementById('mangueiras-details-container').innerHTML = '';
                    document.getElementById('add-mangueira-btn').classList.add('hidden');
                    document.getElementById('mangueira-conditional-section').classList.add('hidden');
                    
                    // Reset P2/P3 states
                    document.getElementById('sub-pergunta-2-1').classList.add('hidden');
                    document.getElementById('sub-pergunta-2-2').classList.add('hidden');
                    document.getElementById('sub-pergunta-3-1').classList.add('hidden');

                    // Garante que os botões de rádio de P1 e P2.1, P3 sejam desmarcados para evitar envio de dados de uma inspeção anterior
                    document.querySelectorAll('[name="pergunta1"]').forEach(radio => radio.checked = false);
                    document.querySelectorAll('[name="pergunta2"]').forEach(radio => radio.checked = false);
                    document.querySelectorAll('[name="pergunta3"]').forEach(radio => radio.checked = false);
                    document.querySelectorAll('[name="pergunta4"]').forEach(radio => radio.checked = false);

                }
            } 
            
            // Pergunta 1: Conformidade da Mangueira
            if (name === 'pergunta1') {
                const section = document.getElementById('mangueira-conditional-section');
                
                if (value === 'Não') {
                    section.classList.remove('hidden');
                    
                    if (window.mangueiraConfigs.length === 0) {
                        window.addMangueiraConfig();
                    } else {
                        window.renderMangueiraDetailsForm(); 
                    }
                    
                } else {
                    section.classList.add('hidden');
                    window.mangueiraConfigs = []; 
                    window.configCounter = 0;
                    document.getElementById('mangueiras-details-container').innerHTML = '';
                    document.getElementById('add-mangueira-btn').classList.add('hidden');
                }
            } 
            
            // Pergunta 2: Possui esguicho? (P2)
            if (name === 'pergunta2') {
                const sub2_1 = document.getElementById('sub-pergunta-2-1');
                const sub2_2 = document.getElementById('sub-pergunta-2-2');
                
                if (value === 'Sim') {
                    sub2_1.classList.remove('hidden');
                    sub2_2.classList.add('hidden'); // Garante P2.2 fechada
                } else {
                    sub2_1.classList.add('hidden');
                    sub2_2.classList.add('hidden');
                }
            }
            
            // Subpergunta 2.1: Possui o esperado? (P2.1)
            if (name === 'subpergunta2-1') {
                const sub2_2 = document.getElementById('sub-pergunta-2-2');
                // P2.1 'Não' abre P2.2
                sub2_2.classList.toggle('hidden', value === 'Sim');
            }

            // Pergunta 3: Possui (Qtde Esperada) Chave Storz? (P3)
            if (name === 'pergunta3') {
                const sub3_1 = document.getElementById('sub-pergunta-3-1');
                // P3 'Não' abre P3.1
                sub3_1.classList.toggle('hidden', value === 'Sim');
            }
        }


        window.onload = function() {
            setupAuthAndFirestore();
            
            const nameInput = document.getElementById('inspector-name');
            const storedName = localStorage.getItem('vistoriadorName');
            
            if (storedName) {
                nameInput.value = storedName;
                window.userName = storedName; 
            }
            
            nameInput.addEventListener('input', (e) => {
                const newName = e.target.value.trim();
                window.userName = newName;
                localStorage.setItem('vistoriadorName', newName);
            });
        }
    </script>
    <style>
        .hydrant-button {
            transition: all 0.2s;
            text-align: left;
            justify-content: flex-start;
        }
        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }
            .grid-cols-2 {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body class="bg-gray-100 font-sans min-h-screen p-4 sm:p-8">

    <div class="max-w-4xl mx-auto">
        <header class="text-center mb-8">
            <h1 class="text-3xl font-extrabold text-blue-800">Ronda e Vistoria de Hidrantes</h1>
            <p class="text-gray-600 mt-1">Status em tempo real sincronizado via Firebase.</p>
        </header>

        <!-- Mensagens de Alerta/Sucesso -->
        <div id="message-box" class="opacity-0 hidden text-sm font-medium transition duration-300"></div>

        <!-- 1. Campo Nome do Vistoriador -->
        <div class="mb-8 p-6 bg-white rounded-xl shadow-lg">
            <label for="inspector-name" class="block text-lg font-bold text-gray-700 mb-2">Nome do Vistoriador</label>
            <input type="text" id="inspector-name" placeholder="Preencha seu nome para iniciar a vistoria" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-blue-500 focus:border-blue-500 transition duration-150">
            <p class="text-xs text-gray-500 mt-2">Este nome aparecerá no hidrante vistoriado e no registro final. (Preenchimento automático ativado)</p>
        </div>
        
        <!-- 2. Botão de Reset Global -->
        <div class="mb-8">
            <button onclick="handleReset()" class="w-full sm:w-auto bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-6 rounded-xl shadow-lg transition duration-150 ease-in-out flex items-center justify-center">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2.122m15.357 2.122H15"></path></svg>
                RESETAR STATUS DOS HIDRANTES
            </button>
        </div>

        <!-- 3. Lista de Hidrantes -->
        <div class="mb-8 p-6 bg-white rounded-xl shadow-lg">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Selecione o Hidrante para Vistoria</h2>
            <div id="hydrant-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                <!-- Os botões de hidrantes serão renderizados aqui via JavaScript -->
            </div>
        </div>
    </div>

    <!-- 4. Modal de Inspeção -->
    <div id="inspection-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50 hidden transition-opacity duration-300">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto transform scale-100 transition-transform duration-300">
            
            <div class="p-6 border-b border-gray-200">
                <h3 id="modal-title" class="text-3xl font-extrabold text-blue-700">Hidrante [Número]</h3>
                <p id="modal-description" class="text-lg text-gray-600 mt-1"></p>
            </div>

            <form id="inspection-form" onsubmit="event.preventDefault(); handleSubmit();" class="p-6 space-y-6" onchange="window.handleConditionalVisibility(event)">
                
                <!-- NOVO: Pergunta 0.1: Sinalização Conforme -->
                <div class="question-group border-b pb-4">
                    <label class="block text-xl font-bold text-gray-800 mb-3">0.1- A placa de sinalização do Hidrante está conforme?</label>
                    <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-4">
                        <label class="inline-flex items-center">
                            <input type="radio" name="pergunta0-1" value="Sim" class="form-radio h-5 w-5 text-green-600" required>
                            <span class="ml-2 text-gray-700">Sim</span>
                        </label>
                        <label class="inline-flex items-center">
                            <input type="radio" name="pergunta0-1" value="Não" class="form-radio h-5 w-5 text-red-600" required>
                            <span class="ml-2 text-gray-700">Não</span>
                        </label>
                    </div>
                </div>

                <!-- NOVO: Pergunta 0.2: Hidrante Lacrado (Define a Condicional) -->
                <div class="question-group border-b pb-4">
                    <label class="block text-xl font-bold text-gray-800 mb-3">0.2- O Hidrante está lacrado?</label>
                    <p class="text-sm text-gray-500 mb-2">Se **SIM**, a inspeção é concluída na próxima etapa. Se **NÃO**, inicie a inspeção completa (P1 a P4).</p>
                    <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-4">
                        <label class="inline-flex items-center">
                            <input type="radio" name="pergunta0-2" value="Sim" class="form-radio h-5 w-5 text-green-600" required>
                            <span class="ml-2 text-gray-700">Sim</span>
                        </label>
                        <label class="inline-flex items-center">
                            <input type="radio" name="pergunta0-2" value="Não" class="form-radio h-5 w-5 text-red-600" required>
                            <span class="ml-2 text-gray-700">Não</span>
                        </label>
                    </div>
                </div>

                <!-- Seção de Inspeção Completa (Abre se P0.2 for 'Não') -->
                <div id="full-inspection-section" class="space-y-6 p-4 border border-gray-300 rounded-xl bg-gray-50 hidden">
                    <h3 class="text-2xl font-bold text-blue-700 mb-4">INSPEÇÃO COMPLETA (P1 a P4)</h3>

                    <!-- Pergunta 1: Conformidade da Mangueira -->
                    <div class="question-group">
                        <label id="mangueiras-pergunta" class="block text-xl font-bold text-gray-800 mb-3"></label>
                        <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-4">
                            <!-- Removido 'required' daqui e adicionado em P0.1/P0.2/P6 -->
                            <label class="inline-flex items-center">
                                <input type="radio" name="pergunta1" value="Sim" class="form-radio h-5 w-5 text-green-600">
                                <span class="ml-2 text-gray-700">Sim</span>
                            </label>
                            <label class="inline-flex items-center">
                                <input type="radio" name="pergunta1" value="Não" class="form-radio h-5 w-5 text-red-600">
                                <span class="ml-2 text-gray-700">Não</span>
                            </label>
                        </div>
                    </div>

                    <!-- Seção Condicional de Mangueiras (Abre se a P1 for 'Não') -->
                    <div id="mangueira-conditional-section" class="hidden p-4 border-2 border-dashed border-red-300 rounded-xl bg-red-50">
                        <h3 class="text-xl font-bold text-red-700 mb-4">CONFIGURAÇÃO DAS MANGUEIRAS NÃO-CONFORMES</h3>
                        
                        <div id="mangueiras-details-container" class="space-y-6">
                            <!-- Formulários de configurações de mangueiras serão injetados aqui -->
                        </div>
                        
                        <button type="button" id="add-mangueira-btn" onclick="window.addMangueiraConfig()" class="hidden w-full mt-4 py-2 bg-yellow-500 text-white font-bold rounded-xl hover:bg-yellow-600 transition duration-150 shadow-md flex items-center justify-center">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                            ADICIONAR OUTRA CONFIGURAÇÃO
                        </button>
                    </div>
                    
                    <!-- Pergunta 2: Possui esguicho? -->
                    <div class="question-group">
                        <label class="block text-xl font-bold text-gray-800 mb-3">2- Possui esguicho?</label>
                        <div class="flex space-x-4">
                            <label class="inline-flex items-center"><input type="radio" name="pergunta2" value="Sim" class="form-radio h-5 w-5 text-green-600"><span class="ml-2 text-gray-700">Sim</span></label>
                            <label class="inline-flex items-center"><input type="radio" name="pergunta2" value="Não" class="form-radio h-5 w-5 text-red-600"><span class="ml-2 text-gray-700">Não</span></label>
                        </div>
                        
                        <!-- Subpergunta 2.1 (Abre se a P2 for 'Sim') -->
                        <div id="sub-pergunta-2-1" class="hidden mt-3 p-3 bg-gray-50 rounded-lg">
                            <label id="subpergunta2-1-label" class="block text-base font-semibold text-gray-700 mb-2">2.1- Possui [Qtde] do tipo [Tipo] (Esperado)?</label>
                            <div class="flex space-x-4">
                                <label class="inline-flex items-center"><input type="radio" name="subpergunta2-1" value="Sim" class="form-radio h-5 w-5 text-green-600"><span class="ml-2 text-gray-700">Sim</span></label>
                                <label class="inline-flex items-center"><input type="radio" name="subpergunta2-1" value="Não" class="form-radio h-5 w-5 text-red-600"><span class="ml-2 text-gray-700">Não</span></label>
                            </div>
                            
                            <!-- Subpergunta 2.2 (Abre se a P2.1 for 'Não') -->
                            <div id="sub-pergunta-2-2" class="hidden mt-3 p-3 bg-red-100 rounded-lg">
                                <label class="block text-base font-semibold text-red-700 mb-2">2.2- Então qual o tipo e quantidade encontrada?</label>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">Tipo</label>
                                        <select name="subpergunta2-2-tipo" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                            <option value="">-</option>
                                            <option value="Agulheta">Agulheta</option>
                                            <option value="Regulável">Regulável</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">Quantidade</label>
                                        <select name="subpergunta2-2-qtd" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                            <option value="">-</option>
                                            <option value="0">0</option>
                                            <option value="1">1</option>
                                            <option value="2">2</option>
                                            <option value="3">3</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Pergunta 3: Chave Storz -->
                    <div class="question-group">
                        <label id="pergunta3-label" class="block text-xl font-bold text-gray-800 mb-3">3- Possui [Qtde] Chave Storz (Esperado)?</label>
                        <div class="flex space-x-4">
                            <label class="inline-flex items-center"><input type="radio" name="pergunta3" value="Sim" class="form-radio h-5 w-5 text-green-600"><span class="ml-2 text-gray-700">Sim</span></label>
                            <label class="inline-flex items-center"><input type="radio" name="pergunta3" value="Não" class="form-radio h-5 w-5 text-red-600"><span class="ml-2 text-gray-700">Não</span></label>
                        </div>
                        <!-- Subpergunta 3.1 (Abre se a P3 for 'Não') -->
                        <div id="sub-pergunta-3-1" class="hidden mt-3 p-3 bg-red-100 rounded-lg">
                            <label class="block text-base font-semibold text-red-700 mb-2">3.1- Quantas foram encontradas?</label>
                            <select name="subpergunta3-1" class="w-full px-3 py-2 border border-red-300 rounded-lg">
                                <option value="Nenhuma">Nenhuma</option>
                                <option value="1">1</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                            </select>
                        </div>
                    </div>

                    <!-- Pergunta 4: Situação Geral -->
                    <div class="question-group">
                        <label class="block text-xl font-bold text-gray-800 mb-3">4- Situação geral conforme?</label>
                        <div class="flex space-x-4">
                            <label class="inline-flex items-center"><input type="radio" name="pergunta4" value="Sim" class="form-radio h-5 w-5 text-green-600"><span class="ml-2 text-gray-700">Sim</span></label>
                            <label class="inline-flex items-center"><input type="radio" name="pergunta4" value="Não" class="form-radio h-5 w-5 text-red-600"><span class="ml-2 text-gray-700">Não</span></label>
                        </div>
                    </div>
                </div> <!-- Fim da Seção de Inspeção Completa -->

                <!-- Pergunta 5: Observações (Sempre visível) -->
                <div class="question-group pt-4 border-t border-gray-200">
                    <label class="block text-xl font-bold text-gray-800 mb-3" for="pergunta5">5- Observações:</label>
                    <textarea id="pergunta5" name="pergunta5" rows="3" placeholder="Detalhes adicionais ou não conformidades..." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"></textarea>
                </div>
                
                <!-- Pergunta 6: Equipe (Sempre visível) -->
                <div class="question-group">
                    <label class="block text-xl font-bold text-gray-800 mb-3">6- Equipe:</label>
                    <select name="pergunta6" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-blue-500 focus:border-blue-500 transition duration-150" required>
                        <option value="">Selecione a Equipe</option>
                        <option value="Alfa">Alfa</option>
                        <option value="Bravo">Bravo</option>
                        <option value="Charlie">Charlie</option>
                        <option value="Delta">Delta</option>
                    </select>
                </div>

                <!-- Botões de Ação -->
                <div class="flex justify-end space-x-4 pt-4 border-t border-gray-200">
                    <button type="button" onclick="closeModal()" class="px-6 py-3 bg-gray-300 text-gray-800 font-bold rounded-xl hover:bg-gray-400 transition duration-150 shadow-md">
                        CANCELAR
                    </button>
                    <button type="submit" class="px-8 py-3 bg-green-600 text-white font-bold rounded-xl hover:bg-green-700 transition duration-150 shadow-lg transform hover:scale-[1.05]">
                        ENVIAR VISTORIA
                    </button>
                </div>

            </form>
        </div>
    </div>
    
    <!-- Template para a seção de Mangueiras NÃO-CONFORMES (ATUALIZADA) -->
    <template id="mangueira-template">
        <div class="mangueira-fields space-y-4 p-4 border border-red-400 rounded-xl bg-white shadow-inner">
            
            <h4 class="text-md font-bold text-gray-700 border-b pb-2 mb-3">Detalhes ENCONTRADOS</h4>

            <!-- 1.1- Qual o tipo? -->
            <div>
                <label class="block text-sm font-medium text-gray-700">Tipo da mangueira:</label>
                <select name="tipo-m" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                    <option value="-">-</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                </select>
            </div>
            <!-- 1.2- Qual o tamanho? -->
            <div>
                <label class="block text-sm font-medium text-gray-700">Tamanho (metros):</label>
                <select name="tamanho-m" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                    <option value="-">-</option>
                    <option value="15">15</option>
                    <option value="20">20</option>
                    <option value="30">30</option>
                </select>
            </div>
            <!-- 1.3- Qual a polegada? -->
            <div>
                <label class="block text-sm font-medium text-gray-700">Polegada:</label>
                <select name="polegada-m" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                    <option value="-">-</option>
                    <option value="1 1/2&quot;">1 1/2"</option>
                    <option value="2 1/2&quot;">2 2/1"</option>
                </select>
            </div>
            
            <!-- Seletor de Quantidade da Configuração (AGORA ABAIXO E INLINE) -->
            <div class="mt-4 pt-4 border-t border-red-300 flex items-center justify-between space-x-4">
                <label class="text-lg font-semibold text-red-700 whitespace-nowrap">Quantidade com esta configuração:</label>
                <select name="qty-m" class="w-full max-w-[150px] px-4 py-2 border border-red-300 rounded-xl bg-white focus:ring-red-500 focus:border-red-500">
                    <option value="0">0</option>
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                </select>
            </div>
        </div>
    </template>

</body>
</html>
